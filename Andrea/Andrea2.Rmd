---
title: "radar script"
output:
  html_document: default
  pdf_document: default
bibliography: Andrea.bib
csl: apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


##### **RaDAr**

In this section we will use the library *RadAR* (Radiomics Analysis with R). This is a software to perform comprehensive analysis of radiomic features. RadAR allows the users to carry out the entire processing of radiomic datasets, from data import to feature processing and visualization and implements multiple statistical methods for the analysis of these data.

First we load the *RadAR* library.
```{r, message=FALSE, results='hide', warning=FALSE}
library(RadAR)
```


With *RadAR* we can import the radiomic features that we extracted before using pyradiomics.

<span style="color:red">TO DO: explain normalizacion y shift, y con normalizacion.</span>

We will create the *rdr* object with normalization and shift, and another one with normalization only. We use the function *import_pyradiomics(path_to_folder)* to import the results we obtained using pyradiomics, where *path_to_folder* is the path to the folder containing the pyradiomics csv files. The function filters out duplicated feature names. 

```{r, eval = FALSE}
rdr_NormShift <- import_pyradiomics(dir="/Users/andrealetaalfonso/Desktop/TFG/A_Project/results/ECLIPSE_results_ParamsNormShiftCSV")
```

```{r, eval = FALSE}
rdr_Norm <- import_pyradiomics(dir="/Users/andrealetaalfonso/Desktop/TFG/A_Project/results/ECLIPSE_results_ParamsNormCSV")
```

We can read the rdr file once it's created:
```{r, warning=FALSE}
library(admisc)
b <- listRDA("rdr_Andrea_NormShift.rda")
b
```

```{r, warning=FALSE}
a <- listRDA("rdr_Andrea_Norm.rda")
rdr <- a$rdr_Norm
rdr
```


The *rdr* object is a *SummarizedExperiment*.

<span style="color:red">TO DO: explain more & add image SummarizedExperiment</span>

The available clinical data can be also imported in the *rdr* object.

We can extract the data with the function *assay()*.
```{r}
data <- assay(rdr_NormShift)
data[1:10,1:2]
```

```{r}
data2 <- assay(rdr_Norm)
data2[1:10,1:2]
```

We can check which image types (i.e., normal or wavelet filtered) features have been extracted from.
```{r}
print_image_type(rdr = rdr_NormShift)
```

The *rdr* object can be also filter by feature type.
```{r}
print_feature_type(rdr = rdr_NormShift)
```

To access to the elements of patients (columns) or features (rows) we can do:
```{r}
names(colData(rdr_NormShift)) # columns
names(rowData(rdr_NormShift)) # rows
```


**Correlation matrix**

Visualize the correlation matrix:
```{r, out.width="70%"}
plot_correlation_matrix(rdr = rdr_NormShift, 
                        method_correlation = "spearman", 
                        view_as = "heatmap", 
                        which_data = "normal")
```

A different way to visualize the correlation matrix is by using correlation plot:
```{r, out.width="70%"}
plot_correlation_matrix(rdr = rdr_NormShift, 
                        method_correlation = "pearson", 
                        view_as = "corrplot", 
                        which_data = "normal")
```


**Pre-processing and visualization of radiomic features**

Scale features:
```{r}
rdr_scaled <- scale_feature_values(rdr = rdr_NormShift, method = "minmax")
```

Group features:
```{r}
rdr <- do_hierarchical_clustering(rdr = rdr_scaled, 
                                  which_data = "scaled", 
                                  method_dist_col = "correlation.spearman")

```

Heat map:
```{r, out.width="70%"}
plot_heatmap_hcl(rdr = rdr) 
```

We can also save the rdr object to *.rda*.
```{r, eval = FALSE}
save(rdr_NormShift, file = "rdr_Andrea_NormShift.rda")
```
```{r, eval = FALSE}
save(rdr_Norm, file = "rdr_Andrea_Norm.rda")
```


We can open the *.rda* file with the following code:
```{r, warning=FALSE, eval = FALSE}
library(admisc)
test_NormShift <- listRDA("rdr_Andrea_NormShift.rda")
test_NormShift
```
```{r, eval = FALSE}
test_Norm <- listRDA("rdr_Andrea_Norm.rda")
test_Norm
```


**Prepare only L1 radar**

Now we are interested in only the time L1.

Open *rdr*:
```{r, warning=FALSE}
a <- listRDA("rdr_Andrea_Norm.rda")
rdr <- a$rdr_Norm
rdr
```

Change names: eliminate the extension of the name and keep the number and separate between different times (L1, L2, L3).
```{r}
o <- colnames(rdr)
oo <- sapply(o, strsplit, "_")
id  <- unlist(lapply(oo, "[[", 1))
time <- unlist(lapply(oo, "[[", 4)) 
df <- data.frame(filename = o, id = id, time = time)
df
```

Change the names of the *id* of the *rdr*, instead of having names like *023140000001_INSP_STD_L1_ECLIPSE.nii.gz.tsv*, we change them to *023140000001*.
```{r}
colnames(rdr) <- id
rdr
```

Add the time (L1, L2, L3) as a new column in our *rdr* object.
```{r}
colData(rdr) <- cbind(colData(rdr), time)
colData(rdr)
```

Let's view our rdr object with all this transformations:
```{r}
rdr
```

Compute how many L1, L2 and L3 we have:
```{r}
table(colData(rdr)$time)
```

Let's create another one but only with T1:
```{r}
rdr_time_L1 <- rdr[, rdr$time == "L1"]
rdr_time_L1
```

It is done correctly because we have now 2371 patients with L1.

Save the radar:
```{r, eval=FALSE}
save(rdr_time_L1, file = "rdr_L1_Andrea.rda")
```

Open the radar:
```{r, warning=FALSE}
file <- listRDA("rdr_L1_Andrea.rda")
rdr_L1 <- file$rdr_L1
rdr_L1
```

Data frame for rdr:
```{r}
data_rdr_L1 <- assay(rdr_L1)
df_rdr <- as.data.frame(data_rdr_L1)
df_rdr[1:10,1:2]
```



##### **Chronic obstructive pulmonary disease (COPD)**

Chronic obstructive pulmonary disease (COPD) is a long-term lung illness in which the lungs' small airways are damaged, making it difficult for air to enter and exit.\

COPD patients commonly experience one or more of the following symptoms:

- having trouble breathing 

- prolonged cough (more than 3 months) 

- a cough with mucus most days

- wheezing (a whistling sound when you breathe)

- chest tightness


Shortness of breath is the most common symptom of COPD. Simple daily tasks like walking short distances or walking a stairway might cause COPD sufferers to become out of breath. Even at rest, breathing might become difficult as the condition progresses.\

Long-term cigarette smoking is the most common cause of COPD. The more cigarettes you smoke, the more likely you are to get COPD.\


##### **Clinical data**

Before we begin with our analysis, we need to explore our clinical data.


##### **Canonical correlation analysis (CCA)**

Now we will analyze the radiomic features against the variables at time T1 using **canonical correlation**.\

Canonical correlation analysis (CCA) is a statistical technique for extracting information from cross-covariance matrices. If we have two vectors of random variables, X = (X1,..., Xn) and Y = (Y1,..., Ym), and the variables are correlated, canonical-correlation analysis will find linear combinations of X and Y that have the highest correlation. \

Multiple correlation analysis predicts only one dependent variable from several independents, but canonical correlation predicts multiple dependent variables from multiple independents.\



###### **Principal Component Analysis (PCA)**

We will first start doing principal component analysis with the radiomic features.\

Recall that PCA is a statistical approach that allows you to summarize the content of big data tables using a smaller set of "summary indices" that are easier to display and study.\


For PCA we want only want categorical data.\


